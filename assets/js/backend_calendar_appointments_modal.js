/* ----------------------------------------------------------------------------
 * Easy!Appointments - Open Source Web Scheduler
 *
 * @package     EasyAppointments
 * @author      A.Tselegidis <alextselegidis@gmail.com>
 * @copyright   Copyright (c) 2013 - 2016, Alex Tselegidis
 * @license     http://opensource.org/licenses/GPL-3.0 - GPLv3
 * @link        http://easyappointments.org
 * @since       v1.2.0
 * ---------------------------------------------------------------------------- */

/**
 * Backend Calendar Appointments Modal
 *
 * This module implements the appointments modal functionality.
 *
 * @module BackendCalendarAppointmentsModal
 */
window.BackendCalendarAppointmentsModal=window.BackendCalendarAppointmentsModal||{};(function(exports){'use strict';function _bindEventHandlers(){$('#manage-appointment #cancel-appointment').click(function(){$('#manage-appointment').modal('hide')});$('#manage-appointment #save-appointment').click(function(){if(!_validateAppointmentForm()){return}
    var $dialog=$('#manage-appointment');var startDatetime=$dialog.find('#start-datetime').datetimepicker('getDate').toString('yyyy-MM-dd HH:mm:ss');var endDatetime=$dialog.find('#end-datetime').datetimepicker('getDate').toString('yyyy-MM-dd HH:mm:ss');var appointment={id_services:$dialog.find('#select-service').val(),id_users_provider:$dialog.find('#select-provider').val(),start_datetime:startDatetime,end_datetime:endDatetime,notes:$dialog.find('#appointment-notes').val(),is_unavailable:!1};if($dialog.find('#appointment-id').val()!==''){appointment.id=$dialog.find('#appointment-id').val()}
    var customer={first_name:$dialog.find('#first-name').val(),last_name:$dialog.find('#last-name').val(),email:$dialog.find('#email').val(),phone_number:$dialog.find('#phone-number').val(),address:$dialog.find('#address').val(),city:$dialog.find('#city').val(),zip_code:$dialog.find('#zip-code').val(),notes:$dialog.find('#customer-notes').val()};if($dialog.find('#customer-id').val()!==''){customer.id=$dialog.find('#customer-id').val();appointment.id_users_customer=customer.id}
    var successCallback=function(response){if(!GeneralFunctions.handleAjaxExceptions(response)){$dialog.find('.modal-message').text(EALang.unexpected_issues_occurred);$dialog.find('.modal-message').addClass('alert-danger').removeClass('hidden');return!1}
        $dialog.find('.modal-message').text(EALang.appointment_saved);$dialog.find('.modal-message').addClass('alert-success').removeClass('alert-danger hidden');$dialog.find('.modal-body').scrollTop(0);setTimeout(function(){$dialog.find('.alert').addClass('hidden');$dialog.modal('hide');$('#select-filter-item').trigger('change')},2000)};var errorCallback=function(){$dialog.find('.modal-message').text(EALang.server_communication_error);$dialog.find('.modal-message').addClass('alert-danger').removeClass('hidden');$dialog.find('.modal-body').scrollTop(0)};BackendCalendarApi.saveAppointment(appointment,customer,successCallback,errorCallback)});$('#insert-appointment').click(function(){BackendCalendarAppointmentsModal.resetAppointmentDialog();var $dialog=$('#manage-appointment');if($('#select-filter-item option:selected').attr('type')=='provider'){var $providerOption=$dialog.find('#select-provider option[value="'+$('#select-filter-item').val()+'"]');if($providerOption.length===0){$.each($dialog.find('#select-service option'),function(){$(this).prop('selected',!0).parent().change();if($providerOption.length>0)
    return!1})}
    $providerOption.prop('selected',!0)}else{$dialog.find('#select-service option[value="'+$('#select-filter-item').val()+'"]').prop('selected',!0)}
    var serviceDuration=0;$.each(GlobalVariables.availableServices,function(index,service){if(service.id==$dialog.find('#select-service').val()){serviceDuration=service.duration;return!1}});var start=new Date();var currentMin=parseInt(start.toString('mm'));if(currentMin>0&&currentMin<15){start.set({'minute':15})}else if(currentMin>15&&currentMin<30){start.set({'minute':30})}else if(currentMin>30&&currentMin<45){start.set({'minute':45})}else{start.addHours(1).set({'minute':0})}
    $dialog.find('#start-datetime').val(GeneralFunctions.formatDate(start,GlobalVariables.dateFormat,!0));$dialog.find('#end-datetime').val(GeneralFunctions.formatDate(start.addMinutes(serviceDuration),GlobalVariables.dateFormat,!0));$dialog.find('.modal-header h3').text(EALang.new_appointment_title);$dialog.modal('show')});$('#select-customer').click(function(){var $list=$('#existing-customers-list');if(!$list.is(':visible')){$(this).text(EALang.hide);$list.empty();$list.slideDown('slow');$('#filter-existing-customers').fadeIn('slow');$('#filter-existing-customers').val('');$.each(GlobalVariables.customers,function(index,c){$list.append('<div data-id="'+c.id+'">'+c.first_name+' '+c.last_name+'</div>')})}else{$list.slideUp('slow');$('#filter-existing-customers').fadeOut('slow');$(this).text(EALang.select)}});$('#manage-appointment').on('click','#existing-customers-list div',function(){var id=$(this).attr('data-id');$.each(GlobalVariables.customers,function(index,c){if(c.id==id){$('#customer-id').val(c.id);$('#first-name').val(c.first_name);$('#last-name').val(c.last_name);$('#email').val(c.email);$('#phone-number').val(c.phone_number);$('#address').val(c.address);$('#city').val(c.city);$('#zip-code').val(c.zip_code);$('#customer-notes').val(c.notes);return!1}});$('#select-customer').trigger('click')});$('#filter-existing-customers').keyup(function(){var key=$(this).val().toLowerCase();var $list=$('#existing-customers-list');var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_filter_customers';var postData={csrfToken:GlobalVariables.csrfToken,key:key};$.ajax({type:'POST',url:postUrl,data:postData,dataType:'json',timeout:1000,global:!1,success:function(response){$list.empty();$.each(response,function(index,c){$list.append('<div data-id="'+c.id+'">'+c.first_name+' '+c.last_name+'</div>');var result=$.grep(GlobalVariables.customers,function(e){return e.id==c.id});if(result.length==0){GlobalVariables.customers.push(c)}})},error:function(jqXHR,textStatus,errorThrown){$list.empty();$.each(GlobalVariables.customers,function(index,c){if(c.first_name.toLowerCase().indexOf(key)!=-1||c.last_name.toLowerCase().indexOf(key)!=-1||c.email.toLowerCase().indexOf(key)!=-1||c.phone_number.toLowerCase().indexOf(key)!=-1||c.address.toLowerCase().indexOf(key)!=-1||c.city.toLowerCase().indexOf(key)!=-1||c.zip_code.toLowerCase().indexOf(key)!=-1||c.notes.toLowerCase().indexOf(key)!=-1){$list.append('<div data-id="'+c.id+'">'+c.first_name+' '+c.last_name+'</div>')}})}})});$('#select-service').change(function(){var sid=$('#select-service').val();$('#select-provider').empty();$.each(GlobalVariables.availableServices,function(indexService,service){if(service.id==sid){var start=$('#start-datetime').datetimepicker('getDate');$('#end-datetime').datetimepicker('setDate',new Date(start.getTime()+service.duration*60000));return!1}});$.each(GlobalVariables.availableProviders,function(indexProvider,provider){$.each(provider.services,function(indexService,serviceId){if(serviceId==sid){var optionHtml='<option value="'+provider.id+'">'+provider.first_name+' '+provider.last_name+'</option>';$('#select-provider').append(optionHtml)}})})});$('#new-customer').click(function(){$('#manage-appointment').find('#customer-id, #first-name, #last-name, #email, '+'#phone-number, #address, #city, #zip-code, #customer-notes').val('')})}
    exports.resetAppointmentDialog=function(){var $dialog=$('#manage-appointment');$dialog.find('input, textarea').val('');$dialog.find('.modal-message').fadeOut();$dialog.find('#select-service').val($dialog.find('#select-service').eq(0).attr('value'));$dialog.find('#select-provider').empty();$.each(GlobalVariables.availableProviders,function(index,provider){var canProvideService=!1;$.each(provider.services,function(index,serviceId){if(serviceId==$dialog.find('#select-service').val()){canProvideService=!0;return!1}});if(canProvideService){var option=new Option(provider.first_name+' '+provider.last_name,provider.id);$dialog.find('#select-provider').append(option)}});$('#existing-customers-list').slideUp('slow');$('#filter-existing-customers').fadeOut('slow');$('#select-customer').text(EALang.select);var serviceDuration=0;$.each(GlobalVariables.availableServices,function(index,service){if(service.id==$dialog.find('#select-service').val()){serviceDuration=service.duration;return!1}});var startDatetime=new Date().addMinutes(GlobalVariables.bookAdvanceTimeout);var endDatetime=new Date().addMinutes(GlobalVariables.bookAdvanceTimeout).addMinutes(serviceDuration);var dateFormat;switch(GlobalVariables.dateFormat){case 'DMY':dateFormat='dd/mm/yy';break;case 'MDY':dateFormat='mm/dd/yy';break;case 'YMD':dateFormat='yy/mm/dd';break;default:throw new Error('Invalid GlobalVariables.dateFormat value.')}
        $dialog.find('#start-datetime').datetimepicker({dateFormat:dateFormat,dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,timeOnlyTitle:EALang.select_time,timeText:EALang.time,hourText:EALang.hour,minuteText:EALang.minutes,firstDay:1});$dialog.find('#start-datetime').datetimepicker('setDate',startDatetime);$dialog.find('#end-datetime').datetimepicker({dateFormat:dateFormat,dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,timeOnlyTitle:EALang.select_time,timeText:EALang.time,hourText:EALang.hour,minuteText:EALang.minutes,firstDay:1});$dialog.find('#end-datetime').datetimepicker('setDate',endDatetime)};function _validateAppointmentForm(){var $dialog=$('#manage-appointment');$dialog.find('.form-group').removeClass('has-error');$dialog.find('.modal-message').addClass('hidden');try{var missingRequiredField=!1;$dialog.find('.required').each(function(){if($(this).val()==''||$(this).val()==null){$(this).parents('.form-group').addClass('has-error');missingRequiredField=!0}});if(missingRequiredField){throw EALang.fields_are_required}
        if(!GeneralFunctions.validateEmail($dialog.find('#email').val())){$dialog.find('#email').parents('.form-group').eq(1).addClass('has-error');throw EALang.invalid_email}
        var start=$('#start-datetime').datetimepicker('getDate');var end=$('#end-datetime').datetimepicker('getDate');if(start>end){$dialog.find('#start-datetime').parents('.form-group').addClass('has-error');$dialog.find('#end-datetime').parents('.form-group').addClass('has-error');throw EALang.start_date_before_end_error}
        return!0}catch(exc){$dialog.find('.modal-message').addClass('alert-danger').text(exc).removeClass('hidden');return!1}}
    exports.initialize=function(){_bindEventHandlers()}})(window.BackendCalendarAppointmentsModal)