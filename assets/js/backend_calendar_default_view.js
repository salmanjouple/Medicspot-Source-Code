/* ----------------------------------------------------------------------------
 * Easy!Appointments - Open Source Web Scheduler
 *
 * @package     EasyAppointments
 * @author      A.Tselegidis <alextselegidis@gmail.com>
 * @copyright   Copyright (c) 2013 - 2016, Alex Tselegidis
 * @license     http://opensource.org/licenses/GPL-3.0 - GPLv3
 * @link        http://easyappointments.org
 * @since       v1.2.0
 * ---------------------------------------------------------------------------- */

/**
 * Backend Calendar
 *
 * This module implements the default calendar view of backend.
 *
 * @module BackendCalendarDefaultView
 */
window.BackendCalendarDefaultView=window.BackendCalendarDefaultView||{};(function(exports){'use strict';var FILTER_TYPE_PROVIDER='provider';var FILTER_TYPE_SERVICE='service';var lastFocusedEventData;function _bindEventHandlers(){var $calendarPage=$('#calendar-page');$('#reload-appointments').click(function(){$('#select-filter-item').trigger('change')});$calendarPage.on('click','.close-popover',function(){$(this).parents().eq(2).remove()});$calendarPage.on('click','.edit-popover',function(){$(this).parents().eq(2).remove();var $dialog;if(lastFocusedEventData.data.is_unavailable==!1){var appointment=lastFocusedEventData.data;$dialog=$('#manage-appointment');BackendCalendarAppointmentsModal.resetAppointmentDialog();$dialog.find('.modal-header h3').text(EALang.edit_appointment_title);$dialog.find('#appointment-id').val(appointment.id);$dialog.find('#select-service').val(appointment.id_services).trigger('change');$dialog.find('#select-provider').val(appointment.id_users_provider);var startDatetime=Date.parseExact(appointment.start_datetime,'yyyy-MM-dd HH:mm:ss');$dialog.find('#start-datetime').datetimepicker('setDate',startDatetime);var endDatetime=Date.parseExact(appointment.end_datetime,'yyyy-MM-dd HH:mm:ss');$dialog.find('#end-datetime').datetimepicker('setDate',endDatetime);var customer=appointment.customer;$dialog.find('#customer-id').val(appointment.id_users_customer);$dialog.find('#first-name').val(customer.first_name);$dialog.find('#last-name').val(customer.last_name);$dialog.find('#email').val(customer.email);$dialog.find('#phone-number').val(customer.phone_number);$dialog.find('#address').val(customer.address);$dialog.find('#city').val(customer.city);$dialog.find('#zip-code').val(customer.zip_code);$dialog.find('#appointment-notes').val(appointment.notes);$dialog.find('#customer-notes').val(customer.notes)}else{var unavailable=lastFocusedEventData.data;unavailable.start_datetime=GeneralFunctions.clone(lastFocusedEventData.start);unavailable.end_datetime=GeneralFunctions.clone(lastFocusedEventData.end);$dialog=$('#manage-unavailable');BackendCalendarUnavailabilitiesModal.resetUnavailableDialog();$dialog.find('.modal-header h3').text('Edit Unavailable Period');$dialog.find('#unavailable-start').datetimepicker('setDate',unavailable.start_datetime);$dialog.find('#unavailable-id').val(unavailable.id);$dialog.find('#unavailable-provider').val(unavailable.id_users_provider);$dialog.find('#unavailable-end').datetimepicker('setDate',unavailable.end_datetime);$dialog.find('#unavailable-notes').val(unavailable.notes)}
    $dialog.modal('show')});$calendarPage.on('click','.delete-popover',function(){$(this).parents().eq(2).remove();if(lastFocusedEventData.data.is_unavailable==!1){var messageButtons={};messageButtons.OK=function(){var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_delete_appointment';var postData={csrfToken:GlobalVariables.csrfToken,appointment_id:lastFocusedEventData.data.id,delete_reason:$('#delete-reason').val()};$.post(postUrl,postData,function(response){$('#message_box').dialog('close');if(response.exceptions){response.exceptions=GeneralFunctions.parseExceptions(response.exceptions);GeneralFunctions.displayMessageBox(GeneralFunctions.EXCEPTIONS_TITLE,GeneralFunctions.EXCEPTIONS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.exceptions));return}
    if(response.warnings){response.warnings=GeneralFunctions.parseExceptions(response.warnings);GeneralFunctions.displayMessageBox(GeneralFunctions.WARNINGS_TITLE,GeneralFunctions.WARNINGS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.warnings))}
    $('#select-filter-item').trigger('change')},'json').fail(GeneralFunctions.ajaxFailureHandler)};messageButtons[EALang.cancel]=function(){$('#message_box').dialog('close')};GeneralFunctions.displayMessageBox(EALang.delete_appointment_title,EALang.write_appointment_removal_reason,messageButtons);$('#message_box').append('<textarea id="delete-reason" rows="3"></textarea>');$('#delete-reason').css('width','100%')}else{var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_delete_unavailable';var postData={csrfToken:GlobalVariables.csrfToken,unavailable_id:lastFocusedEventData.data.id};$.post(postUrl,postData,function(response){$('#message_box').dialog('close');if(response.exceptions){response.exceptions=GeneralFunctions.parseExceptions(response.exceptions);GeneralFunctions.displayMessageBox(GeneralFunctions.EXCEPTIONS_TITLE,GeneralFunctions.EXCEPTIONS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.exceptions));return}
    if(response.warnings){response.warnings=GeneralFunctions.parseExceptions(response.warnings);GeneralFunctions.displayMessageBox(GeneralFunctions.WARNINGS_TITLE,GeneralFunctions.WARNINGS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.warnings))}
    $('#select-filter-item').trigger('change')},'json').fail(GeneralFunctions.ajaxFailureHandler)}});$('#select-filter-item').change(function(){_refreshCalendarAppointments($('#calendar'),$('#select-filter-item').val(),$('#select-filter-item option:selected').attr('type'),$('#calendar').fullCalendar('getView').visStart,$('#calendar').fullCalendar('getView').visEnd);if($('#select-filter-item option:selected').attr('type')===FILTER_TYPE_SERVICE){$('#google-sync, #enable-sync, #insert-appointment, #insert-unavailable').prop('disabled',!0)}else{$('#google-sync, #enable-sync, #insert-appointment, #insert-unavailable').prop('disabled',!1);if($('#select-filter-item option:selected').attr('google-sync')==='true'){$('#enable-sync').addClass('btn-danger enabled');$('#enable-sync span:eq(1)').text(EALang.disable_sync);$('#google-sync').prop('disabled',!1)}else{$('#enable-sync').removeClass('btn-danger enabled');$('#enable-sync span:eq(1)').text(EALang.enable_sync);$('#google-sync').prop('disabled',!0)}}})}
    function _getCalendarHeight(){var result=window.innerHeight-$('#footer').outerHeight()-$('#header').outerHeight()-$('#calendar-toolbar').outerHeight()-60;return(result>500)?result:500}
    function _calendarEventClick(event,jsEvent,view){$('.popover').remove();var html;var displayEdit;var displayDelete;var $parent=$(jsEvent.target.offsetParent);var $altParent=$(jsEvent.target).parents().eq(1);if($parent.hasClass('fc-unavailable')||$altParent.hasClass('fc-unavailable')){displayEdit=(($parent.hasClass('fc-custom')||$altParent.hasClass('fc-custom'))&&GlobalVariables.user.privileges.appointments.edit==!0)?'':'hide';displayDelete=(($parent.hasClass('fc-custom')||$altParent.hasClass('fc-custom'))&&GlobalVariables.user.privileges.appointments.delete==!0)?'':'hide';var notes='';if(event.data){notes='<strong>Notes</strong> '+event.data.notes}
        html='<style type="text/css">'+'.popover-content strong {min-width: 80px; display:inline-block;}'+'.popover-content button {margin-right: 10px;}'+'</style>'+'<strong>'+EALang.start+'</strong> '+GeneralFunctions.formatDate(event.start,GlobalVariables.dateFormat,!0)+'<br>'+'<strong>'+EALang.end+'</strong> '+GeneralFunctions.formatDate(event.end,GlobalVariables.dateFormat,!0)+'<br>'+notes+'<hr>'+'<center>'+'<button class="edit-popover btn btn-primary '+displayEdit+'">'+EALang.edit+'</button>'+'<button class="delete-popover btn btn-danger '+displayDelete+'">'+EALang['delete']+'</button>'+'<button class="close-popover btn btn-default" data-po='+jsEvent.target+'>'+EALang.close+'</button>'+'</center>'}else{displayEdit=(GlobalVariables.user.privileges.appointments.edit==!0)?'':'hide';displayDelete=(GlobalVariables.user.privileges.appointments.delete==!0)?'':'hide';html='<style type="text/css">'+'.popover-content strong {min-width: 80px; display:inline-block;}'+'.popover-content button {margin-right: 10px;}'+'</style>'+'<strong>'+EALang.start+'</strong> '+GeneralFunctions.formatDate(event.start,GlobalVariables.dateFormat,!0)+'<br>'+'<strong>'+EALang.end+'</strong> '+GeneralFunctions.formatDate(event.end,GlobalVariables.dateFormat,!0)+'<br>'+'<strong>'+EALang.service+'</strong> '+event.data.service.name+'<br>'+'<strong>'+EALang.provider+'</strong> '+event.data.provider.first_name+' '+event.data.provider.last_name+'<br>'+'<strong>'+EALang.customer+'</strong> '+event.data.customer.first_name+' '+event.data.customer.last_name+'<hr>'+'<center>'+'<button class="edit-popover btn btn-primary '+displayEdit+'">'+EALang.edit+'</button>'+'<button class="delete-popover btn btn-danger '+displayDelete+'">'+EALang['delete']+'</button>'+'<button class="close-popover btn btn-default" data-po='+jsEvent.target+'>'+EALang.close+'</button>'+'</center>'}
        $(jsEvent.target).popover({placement:'top',title:event.title,content:html,html:!0,container:'#calendar',trigger:'manual'});lastFocusedEventData=event;$(jsEvent.target).popover('toggle');if($('.popover').length>0){if($('.popover').position().top<200)$('.popover').css('top','200px')}}
    function _calendarEventResize(event,dayDelta,minuteDelta,revertFunc,jsEvent,ui,view){if(GlobalVariables.user.privileges.appointments.edit==!1){revertFunc();Backend.displayNotification(EALang.no_privileges_edit_appointments);return}
        if($('#notification').is(':visible')){$('#notification').hide('bind')}
        if(event.data.is_unavailable==!1){var appointment=GeneralFunctions.clone(event.data);delete appointment.customer;delete appointment.provider;delete appointment.service;appointment.end_datetime=Date.parseExact(appointment.end_datetime,'yyyy-MM-dd HH:mm:ss').add({minutes:minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');var successCallback=function(response){if(response.exceptions){response.exceptions=GeneralFunctions.parseExceptions(response.exceptions);GeneralFunctions.displayMessageBox(GeneralFunctions.EXCEPTIONS_TITLE,GeneralFunctions.EXCEPTIONS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.exceptions));return}
            if(response.warnings){response.warnings=GeneralFunctions.parseExceptions(response.warnings);GeneralFunctions.displayMessageBox(GeneralFunctions.WARNINGS_TITLE,GeneralFunctions.WARNINGS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.warnings))}
            var undoFunction=function(){appointment.end_datetime=Date.parseExact(appointment.end_datetime,'yyyy-MM-dd HH:mm:ss').add({minutes:-minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_save_appointment';var postData={csrfToken:GlobalVariables.csrfToken,appointment_data:JSON.stringify(appointment)};$.post(postUrl,postData,function(response){$('#notification').hide('blind');revertFunc()},'json').fail(GeneralFunctions.ajaxFailureHandler)};Backend.displayNotification(EALang.appointment_updated,[{'label':'Undo','function':undoFunction}]);$('#footer').css('position','static')};BackendCalendarApi.saveAppointment(appointment,undefined,successCallback,undefined)}else{var unavailable={id:event.data.id,start_datetime:event.start.toString('yyyy-MM-dd HH:mm:ss'),end_datetime:event.end.toString('yyyy-MM-dd HH:mm:ss'),id_users_provider:event.data.id_users_provider};var successCallback=function(response){if(response.exceptions){response.exceptions=GeneralFunctions.parseExceptions(response.exceptions);GeneralFunctions.displayMessageBox(GeneralFunctions.EXCEPTIONS_TITLE,GeneralFunctions.EXCEPTIONS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.exceptions));return}
            if(response.warnings){response.warnings=GeneralFunctions.parseExceptions(response.warnings);GeneralFunctions.displayMessageBox(GeneralFunctions.WARNINGS_TITLE,GeneralFunctions.WARNINGS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.warnings))}
            var undoFunction=function(){unavailable.end_datetime=Date.parseExact(unavailable.end_datetime,'yyyy-MM-dd HH:mm:ss').add({minutes:-minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_save_unavailable';var postData={csrfToken:GlobalVariables.csrfToken,unavailable:JSON.stringify(unavailable)};$.post(postUrl,postData,function(response){$('#notification').hide('blind');revertFunc()},'json').fail(GeneralFunctions.ajaxFailureHandler)};Backend.displayNotification(EALang.unavailable_updated,[{'label':'Undo','function':undoFunction}]);$('#footer').css('position','static')};BackendCalendarApi.saveUnavailable(unavailable,successCallback,undefined)}}
    function _calendarWindowResize(view){$('#calendar').fullCalendar('option','height',_getCalendarHeight())}
    function _calendarDayClick(date,allDay,jsEvent,view){if(allDay){$('#calendar').fullCalendar('gotoDate',date);$('#calendar').fullCalendar('changeView','agendaDay')}}
    function _calendarEventDrop(event,dayDelta,minuteDelta,allDay,revertFunc,jsEvent,ui,view){if(GlobalVariables.user.privileges.appointments.edit==!1){revertFunc();Backend.displayNotification(EALang.no_privileges_edit_appointments);return}
        if($('#notification').is(':visible')){$('#notification').hide('bind')}
        if(event.data.is_unavailable==!1){var appointment=GeneralFunctions.clone(event.data);delete appointment.customer;delete appointment.provider;delete appointment.service;appointment.start_datetime=Date.parseExact(appointment.start_datetime,'yyyy-MM-dd HH:mm:ss').add({days:dayDelta,minutes:minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');appointment.end_datetime=Date.parseExact(appointment.end_datetime,'yyyy-MM-dd HH:mm:ss').add({days:dayDelta,minutes:minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');event.data.start_datetime=appointment.start_datetime;event.data.end_datetime=appointment.end_datetime;var successCallback=function(response){if(response.exceptions){response.exceptions=GeneralFunctions.parseExceptions(response.exceptions);GeneralFunctions.displayMessageBox(GeneralFunctions.EXCEPTIONS_TITLE,GeneralFunctions.EXCEPTIONS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.exceptions));return}
            if(response.warnings){response.warnings=GeneralFunctions.parseExceptions(response.warnings);GeneralFunctions.displayMessageBox(GeneralFunctions.WARNINGS_TITLE,GeneralFunctions.WARNINGS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.warnings))}
            var undoFunction=function(){appointment.start_datetime=Date.parseExact(appointment.start_datetime,'yyyy-MM-dd HH:mm:ss').add({days:-dayDelta,minutes:-minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');appointment.end_datetime=Date.parseExact(appointment.end_datetime,'yyyy-MM-dd HH:mm:ss').add({days:-dayDelta,minutes:-minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');event.data.start_datetime=appointment.start_datetime;event.data.end_datetime=appointment.end_datetime;var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_save_appointment';var postData={csrfToken:GlobalVariables.csrfToken,appointment_data:JSON.stringify(appointment)};$.post(postUrl,postData,function(response){$('#notification').hide('blind');revertFunc()},'json').fail(GeneralFunctions.ajaxFailureHandler)};Backend.displayNotification(EALang.appointment_updated,[{'label':'Undo','function':undoFunction}]);$('#footer').css('position','static')};BackendCalendarApi.saveAppointment(appointment,undefined,successCallback,undefined)}else{var unavailable={id:event.data.id,start_datetime:event.start.toString('yyyy-MM-dd HH:mm:ss'),end_datetime:event.end.toString('yyyy-MM-dd HH:mm:ss'),id_users_provider:event.data.id_users_provider};var successCallback=function(response){if(response.exceptions){response.exceptions=GeneralFunctions.parseExceptions(response.exceptions);GeneralFunctions.displayMessageBox(GeneralFunctions.EXCEPTIONS_TITLE,GeneralFunctions.EXCEPTIONS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.exceptions));return}
            if(response.warnings){response.warnings=GeneralFunctions.parseExceptions(response.warnings);GeneralFunctions.displayMessageBox(GeneralFunctions.WARNINGS_TITLE,GeneralFunctions.WARNINGS_MESSAGE);$('#message_box').append(GeneralFunctions.exceptionsToHtml(response.warnings))}
            var undoFunction=function(){unavailable.start_datetime=Date.parseExact(unavailable.start_datetime,'yyyy-MM-dd HH:mm:ss').add({days:-dayDelta,minutes:-minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');unavailable.end_datetime=Date.parseExact(unavailable.end_datetime,'yyyy-MM-dd HH:mm:ss').add({days:-dayDelta,minutes:-minuteDelta}).toString('yyyy-MM-dd HH:mm:ss');event.data.start_datetime=unavailable.start_datetime;event.data.end_datetime=unavailable.end_datetime;var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_save_unavailable';var postData={csrfToken:GlobalVariables.csrfToken,unavailable:JSON.stringify(unavailable)};$.post(postUrl,postData,function(response){$('#notification').hide('blind');revertFunc()},'json').fail(GeneralFunctions.ajaxFailureHandler)};Backend.displayNotification(EALang.unavailable_updated,[{label:'Undo',function:undoFunction}]);$('#footer').css('position','static')};BackendCalendarApi.saveUnavailable(unavailable,successCallback,undefined)}}
    function _calendarViewDisplay(){if($('#select-filter-item').val()===null){return}
        _refreshCalendarAppointments($('#calendar'),$('#select-filter-item').val(),$('#select-filter-item option:selected').attr('type'),$('#calendar').fullCalendar('getView').visStart,$('#calendar').fullCalendar('getView').visEnd);$(window).trigger('resize');$('.close-popover').each(function(){$(this).parents().eq(2).remove()});$('.fv-events').each(function(index,eventHandle){$(eventHandle).popover()})}
    function _convertTitlesToHtml(){$('.fc-custom').each(function(){var title=$(this).find('.fc-event-title').text();$(this).find('.fc-event-title').html(title);var time=$(this).find('.fc-event-time').text();$(this).find('.fc-event-time').html(time)})}
    function _refreshCalendarAppointments($calendar,recordId,filterType,startDate,endDate){var postUrl=GlobalVariables.baseUrl+'/backend_api/ajax_get_calendar_appointments';var postData={csrfToken:GlobalVariables.csrfToken,record_id:recordId,start_date:startDate.toString('yyyy-MM-dd'),end_date:endDate.toString('yyyy-MM-dd'),filter_type:filterType};$.post(postUrl,postData,function(response){if(!GeneralFunctions.handleAjaxExceptions(response)){return}
        var calendarEvents=[];var $calendar=$('#calendar');$.each(response.appointments,function(index,appointment){var event={id:appointment.id,title:appointment.cl_clinic_name+' - '+appointment.customer.first_name+' '+appointment.customer.last_name,start:appointment.start_datetime,end:appointment.end_datetime,allDay:!1,data:appointment};calendarEvents.push(event)});$calendar.fullCalendar('removeEvents');$calendar.fullCalendar('addEventSource',calendarEvents);var calendarView=$calendar.fullCalendar('getView').name;if(filterType===FILTER_TYPE_PROVIDER&&calendarView!=='month'){$.each(GlobalVariables.availableProviders,function(index,provider){if(provider.id==recordId){var workingPlan=jQuery.parseJSON(provider.settings.working_plan);var unavailablePeriod;switch(calendarView){case 'agendaDay':var selDayName=$calendar.fullCalendar('getView').start.toString('dddd').toLowerCase();$.each(response.unavailables,function(index,unavailable){var unavailablePeriod={title:EALang.unavailable+' <br><small>'+((unavailable.notes.length>30)?unavailable.notes.substring(0,30)+'...':unavailable.notes)+'</small>',start:Date.parse(unavailable.start_datetime),end:Date.parse(unavailable.end_datetime),allDay:!1,color:'#879DB4',editable:!0,className:'fc-unavailable fc-custom',data:unavailable};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)});if(workingPlan[selDayName]==null){unavailablePeriod={title:EALang.not_working,start:GeneralFunctions.clone($calendar.fullCalendar('getView').start),end:GeneralFunctions.clone($calendar.fullCalendar('getView').end),allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!0);return}
            var calendarDateStart=$calendar.fullCalendar('getView').start,workDateStart=Date.parseExact(calendarDateStart.toString('dd/MM/yyyy')+' '+workingPlan[selDayName].start,'dd/MM/yyyy HH:mm');if(calendarDateStart<workDateStart){unavailablePeriod={title:EALang.not_working,start:calendarDateStart,end:workDateStart,allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)}
            var calendarDateEnd=$calendar.fullCalendar('getView').end;var workDateEnd=Date.parseExact(calendarDateStart.toString('dd/MM/yyyy')+' '+workingPlan[selDayName].end,'dd/MM/yyyy HH:mm');if(calendarDateEnd>workDateEnd){var unavailablePeriod={title:EALang.not_working,start:workDateEnd,end:calendarDateEnd,allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)}
            var breakStart;var breakEnd;$.each(workingPlan[selDayName].breaks,function(index,currBreak){breakStart=Date.parseExact(calendarDateStart.toString('dd/MM/yyyy')+' '+currBreak.start,'dd/MM/yyyy HH:mm');breakEnd=Date.parseExact(calendarDateStart.toString('dd/MM/yyyy')+' '+currBreak.end,'dd/MM/yyyy HH:mm');var unavailablePeriod={title:EALang['break'],start:breakStart,end:breakEnd,allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable fc-break'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)});break;case 'agendaWeek':var currDateStart=GeneralFunctions.clone($calendar.fullCalendar('getView').start);var currDateEnd=GeneralFunctions.clone(currDateStart).addDays(1);$.each(response.unavailables,function(index,unavailable){unavailablePeriod={title:EALang.unavailable+' <br><small>'+((unavailable.notes.length>30)?unavailable.notes.substring(0,30)+'...':unavailable.notes)+'</small>',start:Date.parse(unavailable.start_datetime),end:Date.parse(unavailable.end_datetime),allDay:!1,color:'#879DB4',editable:!0,className:'fc-unavailable fc-custom',data:unavailable};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)});$.each(workingPlan,function(index,workingDay){if(workingDay==null){unavailablePeriod={title:EALang.not_working,start:GeneralFunctions.clone(currDateStart),end:GeneralFunctions.clone(currDateEnd),allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!0);currDateStart.addDays(1);currDateEnd.addDays(1);return}
            var start;var end;start=Date.parseExact(currDateStart.toString('dd/MM/yyyy')+' '+workingDay.start,'dd/MM/yyyy HH:mm');if(currDateStart<start){unavailablePeriod={title:EALang.not_working,start:GeneralFunctions.clone(currDateStart),end:GeneralFunctions.clone(start),allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!0)}
            end=Date.parseExact(currDateStart.toString('dd/MM/yyyy')+' '+workingDay.end,'dd/MM/yyyy HH:mm');if(currDateEnd>end){unavailablePeriod={title:EALang.not_working,start:GeneralFunctions.clone(end),end:GeneralFunctions.clone(currDateEnd),allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable fc-brake'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)}
            var breakStart;var breakEnd;$.each(workingDay.breaks,function(index,currBreak){breakStart=Date.parseExact(currDateStart.toString('dd/MM/yyyy')+' '+currBreak.start,'dd/MM/yyyy HH:mm');breakEnd=Date.parseExact(currDateStart.toString('dd/MM/yyyy')+' '+currBreak.end,'dd/MM/yyyy HH:mm');var unavailablePeriod={title:EALang['break'],start:breakStart,end:breakEnd,allDay:!1,color:'#BEBEBE',editable:!1,className:'fc-unavailable fc-break'};$calendar.fullCalendar('renderEvent',unavailablePeriod,!1)});currDateStart.addDays(1);currDateEnd.addDays(1)});break}}})}},'json').fail(GeneralFunctions.ajaxFailureHandler)}
    exports.initialize=function(){var columnFormat={};switch(GlobalVariables.dateFormat){case 'DMY':columnFormat={month:'ddd',week:'ddd dd/MM',day:'dddd dd/MM'};break;case 'MDY':case 'YMD':columnFormat={month:'ddd',week:'ddd MM/dd',day:'dddd MM/dd'};break;default:throw new Error('Invalid date format setting provided!',GlobalVariables.dateFormat)}
        var defaultView=window.innerWidth<468?'agendaDay':'agendaWeek';$('#calendar').fullCalendar({defaultView:defaultView,height:_getCalendarHeight(),editable:!0,firstDay:1,slotMinutes:30,snapMinutes:15,axisFormat:'HH:mm',timeFormat:'HH:mm{ - HH:mm}',allDayText:EALang.all_day,columnFormat:columnFormat,titleFormat:{month:'MMMM yyyy',week:"MMMM d[ yyyy]{ '&#8212;'[ MMM] d, yyyy}",day:'dddd, MMMM d, yyyy'},header:{left:'prev,next today',center:'title',right:'agendaDay,agendaWeek,month'},monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],monthNamesShort:[EALang.january.substr(0,3),EALang.february.substr(0,3),EALang.march.substr(0,3),EALang.april.substr(0,3),EALang.may.substr(0,3),EALang.june.substr(0,3),EALang.july.substr(0,3),EALang.august.substr(0,3),EALang.september.substr(0,3),EALang.october.substr(0,3),EALang.november.substr(0,3),EALang.december.substr(0,3)],dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],buttonText:{today:EALang.today,day:EALang.day,week:EALang.week,month:EALang.month},windowResize:_calendarWindowResize,viewDisplay:_calendarViewDisplay,dayClick:_calendarDayClick,eventClick:_calendarEventClick,eventResize:_calendarEventResize,eventDrop:_calendarEventDrop,eventAfterAllRender:_convertTitlesToHtml});_calendarWindowResize();if(GlobalVariables.availableProviders.length>0){var optgroupHtml='<optgroup label="'+EALang.providers+'" type="providers-group">';$.each(GlobalVariables.availableProviders,function(index,provider){var hasGoogleSync=(provider.settings.google_sync==='1')?'true':'false';optgroupHtml+='<option value="'+provider.id+'" '+'type="'+FILTER_TYPE_PROVIDER+'" '+'google-sync="'+hasGoogleSync+'">'+provider.first_name+' '+provider.last_name+'</option>'});optgroupHtml+='</optgroup>';$('#select-filter-item').append(optgroupHtml)}
        if(GlobalVariables.availableServices.length>0){optgroupHtml='<optgroup label="'+EALang.services+'" type="services-group">';$.each(GlobalVariables.availableServices,function(index,service){optgroupHtml+='<option value="'+service.id+'" '+'type="'+FILTER_TYPE_SERVICE+'">'+service.name+'</option>'});optgroupHtml+='</optgroup>';$('#select-filter-item').append(optgroupHtml)}
        if(GlobalVariables.user.role_slug==Backend.DB_SLUG_PROVIDER){$('#select-filter-item optgroup:eq(0)').find('option[value="'+GlobalVariables.user.id+'"]').prop('selected',!0);$('#select-filter-item').prop('disabled',!0)}
        if(GlobalVariables.user.role_slug==Backend.DB_SLUG_SECRETARY){$('#select-filter-item optgroup:eq(1)').remove()}
        if(GlobalVariables.user.role_slug==Backend.DB_SLUG_SECRETARY){$('#select-filter-item option[type="provider"]').each(function(index,option){var found=!1;$.each(GlobalVariables.secretaryProviders,function(index,id){if($(option).val()==id){found=!0;return!1}});if(!found){$(option).remove()}});if($('#select-filter-item option[type="provider"]').length==0){$('#select-filter-item optgroup[type="providers-group"]').remove()}}
        _bindEventHandlers();$('#select-filter-item').trigger('change');if(GlobalVariables.editAppointment!=null){var $dialog=$('#manage-appointment');var appointment=GlobalVariables.editAppointment;BackendCalendarAppointmentsModal.resetAppointmentDialog();$dialog.find('.modal-header h3').text(EALang.edit_appointment_title);$dialog.find('#appointment-id').val(appointment.id);$dialog.find('#select-service').val(appointment.id_services).change();$dialog.find('#select-provider').val(appointment.id_users_provider);var startDatetime=Date.parseExact(appointment.start_datetime,'yyyy-MM-dd HH:mm:ss');$dialog.find('#start-datetime').val(GeneralFunctions.formatDate(startDatetime,GlobalVariables.dateFormat,!0));var endDatetime=Date.parseExact(appointment.end_datetime,'yyyy-MM-dd HH:mm:ss');$dialog.find('#end-datetime').val(GeneralFunctions.formatDate(endDatetime,GlobalVariables.dateFormat,!0));var customer=appointment.customer;$dialog.find('#customer-id').val(appointment.id_users_customer);$dialog.find('#first-name').val(customer.first_name);$dialog.find('#last-name').val(customer.last_name);$dialog.find('#email').val(customer.email);$dialog.find('#phone-number').val(customer.phone_number);$dialog.find('#address').val(customer.address);$dialog.find('#city').val(customer.city);$dialog.find('#zip-code').val(customer.zip_code);$dialog.find('#appointment-notes').val(appointment.notes);$dialog.find('#customer-notes').val(customer.notes);$dialog.modal('show')}
        $('#calendar-toolbar button').qtip({position:{my:'top center',at:'bottom center'},style:{classes:'qtip-green qtip-shadow custom-qtip'}});$('#select-filter-item').qtip({position:{my:'middle left',at:'middle right'},style:{classes:'qtip-green qtip-shadow custom-qtip'}});if($('#select-filter-item option').length==0){$('#calendar-actions button').prop('disabled',!0)}
        if(window.innerHeight<700){$('#footer').css('position','static')}}})(window.BackendCalendarDefaultView)