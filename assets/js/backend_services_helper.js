/* ----------------------------------------------------------------------------
 * Easy!Appointments - Open Source Web Scheduler
 *
 * @package     EasyAppointments
 * @author      A.Tselegidis <alextselegidis@gmail.com>
 * @copyright   Copyright (c) 2013 - 2016, Alex Tselegidis
 * @license     http://opensource.org/licenses/GPL-3.0 - GPLv3
 * @link        http://easyappointments.org
 * @since       v1.0.0
 * ---------------------------------------------------------------------------- */

(function(){'use strict';function ServicesHelper(){this.filterResults={}};ServicesHelper.prototype.bindEventHandlers=function(){var instance=this;$('#filter-services form').submit(function(event){var key=$('#filter-services .key').val();$('#filter-services .selected').removeClass('selected');instance.resetForm();instance.filter(key);return!1});$('#filter-services .clear').click(function(){$('#filter-services .key').val('');instance.filter('');instance.resetForm()});$(document).on('click','.service-row',function(){if($('#filter-services .filter').prop('disabled')){$('#filter-services .results').css('color','#AAA');return}
    var serviceId=$(this).attr('data-id');var service={};$.each(instance.filterResults,function(index,item){if(item.id===serviceId){service=item;return!1}});var dedicatedUrl=GlobalVariables.baseUrl+'/index.php?service='+encodeURIComponent(service.id);var linkHtml='<a href="'+dedicatedUrl+'"><span class="glyphicon glyphicon-link"></span></a>';$('#services .record-details h3').find('a').remove().end().append(linkHtml);instance.display(service);$('#filter-services .selected').removeClass('selected');$(this).addClass('selected');$('#edit-service, #delete-service').prop('disabled',!1)});$('#add-service').click(function(){instance.resetForm();$('#services .add-edit-delete-group').hide();$('#services .save-cancel-group').show();$('#services .record-details').find('input, textarea').prop('readonly',!1);$('#services .record-details').find('select').prop('disabled',!1);$('#service-duration, #service-attendants-number').spinner('enable');$('#filter-services button').prop('disabled',!0);$('#filter-services .results').css('color','#AAA')});$('#cancel-service').click(function(){var id=$('#service-id').val();instance.resetForm();if(id!==''){instance.select(id,!0)}});$('#save-service').click(function(){var service={name:$('#service-name').val(),duration:$('#service-duration').val(),price:$('#service-price').val(),currency:$('#service-currency').val(),description:$('#service-description').val(),availabilities_type:$('#service-availabilities-type').val(),attendants_number:$('#service-attendants-number').val()};if($('#service-category').val()!=='null'){service.id_service_categories=$('#service-category').val()}else{service.id_service_categories=null}
    if($('#service-id').val()!==''){service.id=$('#service-id').val()}
    if(!instance.validate(service)){return}
    instance.save(service)});$('#edit-service').click(function(){$('#services .add-edit-delete-group').hide();$('#services .save-cancel-group').show();$('#services .record-details').find('input, textarea').prop('readonly',!1);$('#services .record-details select').prop('disabled',!1);$('#service-duration, #service-attendants-number').spinner('enable');$('#filter-services button').prop('disabled',!0);$('#filter-services .results').css('color','#AAA')});$('#delete-service').click(function(){var serviceId=$('#service-id').val();var messageBtns={};messageBtns[EALang['delete']]=function(){instance.delete(serviceId);$('#message_box').dialog('close')};messageBtns[EALang.cancel]=function(){$('#message_box').dialog('close')};GeneralFunctions.displayMessageBox(EALang.delete_service,EALang.delete_record_prompt,messageBtns)})};ServicesHelper.prototype.save=function(service){var postUrl=GlobalVariables.baseUrl+'//backend_api/ajax_save_service';var postData={csrfToken:GlobalVariables.csrfToken,service:JSON.stringify(service)};$.post(postUrl,postData,function(response){if(!GeneralFunctions.handleAjaxExceptions(response)){return}
    Backend.displayNotification(EALang.service_saved);this.resetForm();$('#filter-services .key').val('');this.filter('',response.id,!0)}.bind(this),'json').fail(GeneralFunctions.ajaxFailureHandler)};ServicesHelper.prototype.delete=function(id){var postUrl=GlobalVariables.baseUrl+'//backend_api/ajax_delete_service';var postData={csrfToken:GlobalVariables.csrfToken,service_id:id};$.post(postUrl,postData,function(response){if(!GeneralFunctions.handleAjaxExceptions(response)){return}
    Backend.displayNotification(EALang.service_deleted);this.resetForm();this.filter($('#filter-services .key').val())}.bind(this),'json').fail(GeneralFunctions.ajaxFailureHandler)};ServicesHelper.prototype.validate=function(service){$('#services .required').css('border','');try{var missingRequired=!1;$('#services .required').each(function(){if($(this).val()==''||$(this).val()==undefined){$(this).css('border','2px solid red');missingRequired=!0}});if(missingRequired){throw EALang.fields_are_required}
    return!0}catch(exc){return!1}};ServicesHelper.prototype.resetForm=function(){$('#services .record-details').find('input, textarea').val('');$('#service-category').val('null');$('#services .add-edit-delete-group').show();$('#services .save-cancel-group').hide();$('#edit-service, #delete-service').prop('disabled',!0);$('#services .record-details').find('input, textarea').prop('readonly',!0);$('#services .record-details').find('select').prop('disabled',!0);$('#service-duration, #service-attendants-number').spinner('disable');$('#filter-services .selected').removeClass('selected');$('#filter-services button').prop('disabled',!1);$('#filter-services .results').css('color','')};ServicesHelper.prototype.display=function(service){$('#service-id').val(service.id);$('#service-name').val(service.name);$('#service-duration').val(service.duration);$('#service-price').val(service.price);$('#service-currency').val(service.currency);$('#service-description').val(service.description);$('#service-availabilities-type').val(service.availabilities_type);$('#service-attendants-number').val(service.attendants_number);var categoryId=(service.id_service_categories!==null)?service.id_service_categories:'null';$('#service-category').val(categoryId)};ServicesHelper.prototype.filter=function(key,selectId,display){display=display||!1;var postUrl=GlobalVariables.baseUrl+'//backend_api/ajax_filter_services';var postData={csrfToken:GlobalVariables.csrfToken,key:key};$.post(postUrl,postData,function(response){if(!GeneralFunctions.handleAjaxExceptions(response)){return}
    this.filterResults=response;$('#filter-services .results').data('jsp').destroy();$('#filter-services .results').html('');$.each(response,function(index,service){var html=ServicesHelper.prototype.getFilterHtml(service);$('#filter-services .results').append(html)});$('#filter-services .results').jScrollPane({mouseWheelSpeed:70});if(response.length===0){$('#filter-services .results').html('<em>'+EALang.no_records_found+'</em>')}
    if(selectId!==undefined){this.select(selectId,display)}}.bind(this),'json').fail(GeneralFunctions.ajaxFailureHandler)};ServicesHelper.prototype.getFilterHtml=function(service){var html='<div class="service-row entry" data-id="'+service.id+'">'+'<strong>'+service.name+'</strong><br>'+service.duration+' min - '+service.price+' '+service.currency+'<br>'+'</div><hr>';return html};ServicesHelper.prototype.select=function(id,display){display=display||!1;$('#filter-services .selected').removeClass('selected');$('#filter-services .service-row').each(function(){if($(this).attr('data-id')===id){$(this).addClass('selected');return!1}});if(display){$.each(this.filterResults,function(index,service){if(service.id===id){this.display(service);$('#edit-service, #delete-service').prop('disabled',!1);return!1}}.bind(this))}};window.ServicesHelper=ServicesHelper})()